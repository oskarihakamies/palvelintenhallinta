# h4.Pkg-file-service




##  Karvinen 2018: Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port


- Artikkeli näyttää yksinkertaisemman Salt tilan muuttaakseen SSH serverin porttia.
- Tässä myös näytetään hyvät ohjeet siihen esimerkkinä, miten SSH tila luodaan ja miten sitä voi käyttää alamaisiin (slaves)
- Artikkelissa näkyy jonkin muun henkilön sshd_config file.


12.11 klo 12.41 tehty ensimmäinen osa. 




a)

16.11 klo 17.11 aloitin A-osan teon.


SSHouto. Tehtävän tarkoituksena oli lisätä uusi portti, jossa SSHd kuuntelee. Aloitin tehtävän kirjautumalla ensin minion-koneelle SSH:lla portin 22 kautta. 


Muokkasin /etc/ssh/sshd_config-tiedostoa lisäämällä rivin Port 8888 olemassa olevan Port 22:n alle.


<img width="431" height="249" alt="image" src="https://github.com/user-attachments/assets/349e5d4b-883f-4c27-9bff-700477a398ed" />

Näämme nanossa, että port 22 on tällä hetkellä vain olemassa. 

<img width="440" height="284" alt="image" src="https://github.com/user-attachments/assets/70c20cd5-d874-4b56-96a3-3a85cfa219e8" />


Lisäsin uuden portin ja tallensin sen. 


16.11 klo 17.14 jatkoin tehtävän tekoa. 


Käynnistin seuraavaksi sshd-palvelun uudelleen komennolla sudo systemctl restart ssh. Tarkistan tilan systemctl status ssh:lla.


<img width="442" height="240" alt="image" src="https://github.com/user-attachments/assets/32aad11c-b998-4584-86c7-69693ec8337b" />


Kuten näämme, niin se näkyy aktiivisena, mutta tällä kertaa port 8888 on lisättynä. 


Testasin uutta porttia vaihtamalla takasin host-koneeseeni ja käynnistin vagrantin. 

<img width="579" height="304" alt="image" src="https://github.com/user-attachments/assets/36a64457-d447-4eaf-8be3-d960ee5d51d2" />

Vagrantia käynnistäessä sattui virhe, joten poistin Vagrantfilen ja kokeilin uudestaan käynnistystä. 


16.11 klo 17.28 alkoi vianrajaus. 


<img width="589" height="98" alt="image" src="https://github.com/user-attachments/assets/f1899ae0-1b68-47b2-b2d7-657f2aa1eb9d" />

Sain poistettua sen ja jatkoin tehtäväntekoa. Aloitin uudestaan vagrantin ja se toimi. 


<img width="689" height="302" alt="image" src="https://github.com/user-attachments/assets/fe8d5cfb-95b7-446f-b95d-88b3c09ebad3" />



Vagrant siis käynnistyi. 

16.11 Klo 17.42 tuli uusi ongelma vastaan. 


Seuraava ongelma saapui, kun port 8888, minkä lisäsin debianiin ei suostunut näkymään host-koneessani. Lisäsin sen siis itselleni vagrantfileen host koneessa komennolla config.vm.network "forwarded_port", guest: 8888, host: 8888 ja tallensin sen. 

<img width="637" height="183" alt="image" src="https://github.com/user-attachments/assets/9ea548cc-350f-4a1f-8ba7-3796fc1f5e65" />

Kokeilin seuraavaksi uudestaan sitä reloadamalla vagrantin ja se onnistui. 

<img width="703" height="191" alt="image" src="https://github.com/user-attachments/assets/58e33e91-40e3-4af9-9e49-3a6c6649cf49" />

Käytin windowsin omaa komentoa Test-NetConnectia tilanteessa, sillä en käytä tällä hetkellä linuxia hostina. 


16.11 Klo 18.25

Seuraavaksi aloin luomaan sls-tiedoston ja salt mallin, jotka saisin host koneelle. 


Tässä muodostui taas uusi ongelma.


<img width="299" height="93" alt="image" src="https://github.com/user-attachments/assets/594070a7-4e3a-4304-86d5-303aa3463efe" />


Minulla tiedosto näyttää portin olevan lisätty, mutta se ei silti ole päällä?


<img width="448" height="228" alt="image" src="https://github.com/user-attachments/assets/157e6174-2d18-41a2-b2a6-273f17ffe145" />



8888 ei muodostu. Nyt ongelma muodostuu host koneella. 


16.11 klo 20.27 ties mones ongelma jatkui. 


<img width="580" height="107" alt="image" src="https://github.com/user-attachments/assets/b0d3e9cd-116f-4245-b2d3-4a6e45576416" />

Yhteys vain sulkeutuu enkä tiedä, miten jatkaa. 


Nyt en pääse tekemään mitään jatkoa. Kuitenkin lopullinen testi SSH-yhteydellä portilla 8888 (ssh -p 8888 oskari@127.0.0.1) epäonnistui toistuvasti "kex_exchange_identification: read: Connection aborted" -virheellä – vaikka config, firewall (ufw allow 8888) ja forwarding olivat OK, sshd ei vastannut banner-vaiheessa (en tiedä oliko kyseessä VM sisäinen ongelma vai mikäö). En pystynyt tekemään täyttä SLS-tiedoston testausta (state.apply) tämän yhteysongelman takia, sillä se estää host-koneelta VM:ään pääsyn. Tehtävä lopulta epäonnistui, sillä se ei yhdistä host-koneelta.



16.11 klo 21.31 tehtävän lopulta päätin, kun en päässyt eteenpäin. Yritin katsella VM sisällä olevia portteja ja katsoa, että port forwarding asetuksissa oli ok. Kesti kauan, mutta en päässyt loppuun asti. 







## Lähteet

- Karvinen 2018: Pkg-File-Service – Control Daemons with Salt – Change SSH Server Port, https://terokarvinen.com/2018/04/03/pkg-file-service-control-daemons-with-salt-change-ssh-server-port/?fromSearch=karvinen%20salt%20ssh Luettu 12.11.2025
